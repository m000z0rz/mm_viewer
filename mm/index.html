<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<script src="https://d3js.org/d3.v5.min.js"></script>

	<!--Bootstrap-->
	<!-- CSS only -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

	<!-- JS, Popper.js, and jQuery -->
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

	<title>MM</title>

</head>
<body>
	<div id="main">
		
	</div>

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
	<script>
		var requestDelay = 100;

		$(document).ready(function () {
			var ajax = new XMLHttpRequest();
			ajax.onreadystatechange = function()
			{
				if (this.readyState === 4 && this.status === 200)
				{
					//document.getElementById("main").innerHTML = this.response.replace(/\n/g, "<br/>", /\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
					drawPositions(JSON.parse(this.response));
					setTimeout(doRequest, requestDelay);
				}
			}
			ajax.onerror = function()
			{
				// try again in a bit
				setTimeout(doRequest, 1000);
			}

			function doRequest()
			{
				ajax.open("GET", "http://localhost:7777/test", true);
				ajax.responseType = "text";
				ajax.send();
			}

			doRequest();

		});

		const width = 800, height = 600;
		const svg = d3.select("#main")
			.append("svg") //create("svg")
			.attr("viewBox", [0, 0, width, height])
			.attr("width", width)
			.attr("height", height)
			;

		const g = svg.append("g");



		function drawPositions(data)
		{
			// array of objects groups, which are arrays of objects
			//console.log("data", data);

			// Assign key to each object based on their type id and index within their group

			// Skip link in early data; we only use the camera one
			data.forEach(group => {
				group.forEach((obj, index) => {
					obj.key = obj.id + ":" + index;
				});
			});

			data = data.flat();

			//console.log("newdata", data);
			//console.log("links", data.filter(d => d.id === 0).map(d => "(" + d.currPosRot.pos.x + ", " + d.currPosRot.pos.z + ")"));
			const viewMinX = d3.min(data, d => d.currPosRot.pos.x - 20) || 0;
			const viewMinY = d3.min(data, d => d.currPosRot.pos.z - 20) || 0;
			const viewMaxX = d3.max(data, d => d.currPosRot.pos.x + 20) || 0;
			const viewMaxY = d3.max(data, d => d.currPosRot.pos.z + 20) || 0;

			if (viewMinX === viewMaxX || viewMinY === viewMaxY)
			{
				// nothing exists, skip the update, may have just died
				return;
			}

			svg.attr("viewBox", [
				viewMinX, viewMinY, viewMaxX - viewMinX, viewMaxY - viewMinY
			]);

			
			const radii = {
				16: 15 // make tatl smaller
			};

			const fillColors = {
				0: "green", // link
				387: "pink", // deku flower
				16: "beige", // tatl
			};

			const circles = g.selectAll("circle")
				.data(data, d => d.key)
				;

			circles
				.transition(t)
				.attr("cx", d=> d.currPosRot.pos.x)
				.attr("cy", d => d.currPosRot.pos.z)
				;

			newCircles = circles.enter()
				.append("circle")
				.attr("r", d => radii[d.id] || 20)
				.style("stroke-width", 3)
				.style("stroke", "black")
				.style("fill", d => fillColors[d.id] || "grey")
				.attr("cx", d=> d.currPosRot.pos.x)
				.attr("cy", d => d.currPosRot.pos.z)
				;

			newCircles
				.append("title")
				.text(d => d.id)
				;

			var t = d3.transition()
				.duration(requestDelay)
				.ease(d3.easeLinear)
				;

			
				//.each(d => console.log("hi", d))
				;

			// circles
			// 	.attr("x", d=> d.pos.x)
			// 	.attr("y", d => d.pos.y)
			// 	.attr("title", d => d.id)
			// 	;

			circles.exit()
				.remove();


		}

	</script>
</body>
</html>